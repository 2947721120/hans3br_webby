<!--

Our input which connects a slider and number input together. Also includes
a title and description which collapses on click

-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id='dd-slider-input'>
  
  <style is='custom-style'>
  
    :host {
      display: block;
      margin-right: 16px;
    }
    
    iron-collapse {
      margin: 0px 24px 12px 24px;
      text-align: justify;
    }
    
    paper-icon-button {
      --iron-icon-width: 18px;
      --iron-icon-height: 18px
    }
    
    input[type=number] {
      font: inherit;
      color: inherit;
      border: none;
      background: inherit;
      text-align: right;
    }
    
    input:focus {
      outline: none;
      border-bottom: 1px solid white;
    }
    
    /* remove the input arrows that show up in webkit browsers when using numeric input*/
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      -moz-appearance: none;
      margin: 0;
    }
    
  </style>
  
  <template>
      
    <paper-item class='layout horizontal center mdl-card__subtitle-text'>
      
      <paper-icon-button icon='icons:info-outline' hidden$='{{selectMode}}' on-tap='toggleDetails'></paper-icon-button>
      
      <paper-checkbox id='hidebox' on-change='_toggleHide' hidden$='{{!selectMode}}'></paper-checkbox>
      
      <div class='flex'>
        <content select='.title'></content>
      </div>
      
        
      <input  
        id='put'
        type='number'
        max='{{max}}'
        min='{{min}}'
        step='{{step}}'
        disabled='{{!active}}'
        maxlength='5'>
      </input>
      
      <content select='.units'></content>
      
    </paper-item>
    
    <iron-collapse id='collapse'>
      
      <div class='mdl-card__supporting-text'>
        <content select='.description'></content>
      </div>
      
        
      <div class='horizontal layout center' hidden$='{{!active}}'>

        <paper-icon-button 
            icon='icons:remove-circle-outline' 
            on-tap='removeStep'>
        </paper-icon-button>
      
        <paper-slider 
            id='slid'
            min='{{min}}'
            max='{{max}}'
            step='{{step}}'
            class='flex'>
        </paper-slider>
                      
        <paper-icon-button 
            icon='icons:add-circle-outline' 
            on-tap='addStep'>
        </paper-icon-button>
        
      </div>
      
      <content></content>
      
    </iron-collapse>
    
    <paper-toast 
        id='toast' 
        text="Value must be between {{min}} and {{max}}">
    </paper-toast>
    
  </template>
  
</dom-module>

<script>
  Polymer({
    
    is: 'dd-slider-input', 
    
    properties: {
      
      selectMode: {
        type: Boolean,
        value: false, 
        observer: '_toggleSelectMode'
      },
      
      hide: {
        type: Boolean, 
        value: false,
      },
      
      val: {
        type: Number, 
        value: 50,
        observer: '_valChanged',
        notify: true
      },
      
      min: {
        type: Number,
        value: 0
      }, 
      
      max: {
        type: Number,
        value: 5000
      },
      
      decimals: {
        type: Number,
        value: 1,
      },
      
      step: {
        type: Number,
        computed: '_computeStep(decimals)'
      },
      
      active: {
        type: Boolean,
        value: false
      }
    },
    
    ready: function() {
      this._valChanged(this.val);
      //set the checkbox to the correct state
      //this will depend if the hide attribute is used or not
      this.$.hidebox.checked = !this.hide;
      if(this.hide) {
        this.style.opacity = 0.4;
        this.style.display = 'none';
      }
    },
    
    listeners: {
      'change': '_userInput',
      'immediate-value-change': '_sliderInput'
    },
    
    _toggleSelectMode: function(newValue, oldValue) {
      //close the detail view if open
      //for some reason hide() is not working so we check it state and toggle().
      if(this.$.collapse.opened) {this.$.collapse.toggle();}
      
      if(newValue) {
        //If we are in select mode we want to show all elements regardless if they
        //are currently selected as hidden
        this.style.display = 'block';
      } else if(this.hide) {
        //if the toggle is false we want to return the hidden state if hidden
        this.style.display = 'none';
      } else {
        //if both not hidden and not select mode we display normal block
        this.style.display = 'block';
      }
    },
    
    _toggleHide: function(event) {
      //we set the hide attribute to the oppostie of the checked state
      this.hide = !this.$.hidebox.checked;
      //when in select mode we want to use low opacity to hightlight not selected
      if(this.hide) {
        //when select mode is choosen font will show with low opacity
        this.style.opacity = 0.4;
      } else {
        //reset opacity for normal display
        this.style.opacity = 1;
      }
      event.stopPropagation();
    },
    
    /**called to visually show the value that is being selected
     * the actual value will be checked and set when userInput is called
     * with the on-change event
     */
    _sliderInput: function() {
      this.val = this.$.slid.immediateValue;
    },
    
    toggleDetails: function() {
      this.$.collapse.toggle();
    },
  
    _valChanged: function(newValue, oldValue) {
      this.$.put.value = Number(newValue).toFixed(this.decimals);
      this.$.slid.value = Number(newValue).toFixed(this.decimals);
      this.fire('dd-slider-input-changed');
    },
    
    _userInput: function(e){
      if(e.target.value < this.min){
        this.val = this.min;  
        this.$.toast.show();
      } else if (e.target.value > this.max){
        this.val = this.max; 
        this.$.toast.show();
      } else {
        this.val = e.target.value;
      }
    },
    
    _computeStep: function(dec) {
      return 1 / Math.pow(10, dec);
    },
    
    addStep: function() {
      if(this.val < this.max){
        //for some reason when just adding step it causes and error so we subtract (1) and add (2).
       var temp = this.val - this.step + 2 * this.step;  
       this.val = Number(temp).toFixed(this.decimals); //fires val observer
      }
    },
  
    //remove a vale when the button is clicked
    //needs to be universal as the slider is updated for different inputs
    removeStep: function() {
      if(this.val > this.min){
        var temp = this.val - this.step;
        this.val = Number(temp).toFixed(this.decimals);  //fire val observer
      }
    }
    
});
</script>